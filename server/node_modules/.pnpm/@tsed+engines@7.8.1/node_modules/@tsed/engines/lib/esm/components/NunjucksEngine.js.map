{"version":3,"file":"NunjucksEngine.js","sourceRoot":"","sources":["../../../src/components/NunjucksEngine.ts"],"names":[],"mappings":";AAAA,OAAO,EAAC,SAAS,EAAC,MAAM,MAAM,CAAC;AAC/B,OAAO,EAAC,UAAU,EAAC,MAAM,0BAA0B,CAAC;AACpD,OAAO,EAAC,MAAM,EAAC,MAAM,UAAU,CAAC;AAGhC,IAAa,cAAc,GAA3B,MAAa,cAAe,SAAQ,MAAM;IAC9B,SAAS,CAAC,OAAY;QAC9B,MAAM,MAAM,GAAG,OAAO,CAAC,WAAW,IAAI,IAAI,CAAC,MAAM,CAAC;QAClD,IAAI,GAAG,GAAG,MAAM,CAAC;QAEjB,0CAA0C;QAC1C,kDAAkD;QAClD,kDAAkD;QAClD,IAAI,OAAO,CAAC,QAAQ,IAAI,OAAO,CAAC,QAAQ,CAAC,KAAK,EAAE;YAC9C,GAAG,GAAG,MAAM,CAAC,SAAS,CAAC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;SAChD;aAAM,IAAI,OAAO,CAAC,QAAQ,IAAI,OAAO,CAAC,QAAQ,CAAC,SAAS,EAAE;YACzD,yCAAyC;YACzC,GAAG,GAAG,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC,MAAM,EAAE,OAAO,CAAC,QAAQ,CAAC,SAAS,CAAC,CAAC;SAClE;QAED,EAAE;QACF,mDAAmD;QACnD,oDAAoD;QACpD,mFAAmF;QACnF,EAAE;QACF,mDAAmD;QACnD,mEAAmE;QACnE,EAAE;QAEF,0DAA0D;QAC1D,iDAAiD;QACjD,IAAI,OAAO,CAAC,MAAM,EAAE;YAClB,OAAO,IAAI,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;SAC/C;QAED,IAAI,OAAO,CAAC,QAAQ,IAAI,OAAO,CAAC,QAAQ,CAAC,KAAK,EAAE;YAC9C,OAAO,IAAI,MAAM,CAAC,WAAW,CAAC,IAAI,MAAM,CAAC,gBAAgB,CAAC,OAAO,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC,CAAC;SACpF;QAED,IAAI,OAAO,CAAC,QAAQ,IAAI,OAAO,CAAC,QAAQ,CAAC,MAAM,EAAE;YAC/C,IAAI,OAAO,OAAO,CAAC,QAAQ,CAAC,MAAM,KAAK,QAAQ,EAAE;gBAC/C,OAAO,IAAI,MAAM,CAAC,WAAW,CAAC,IAAI,MAAM,CAAC,gBAAgB,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;aACrF;YAED,OAAO,IAAI,MAAM,CAAC,WAAW,CAAC,IAAI,MAAM,CAAC,gBAAgB,CAAC,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,OAAO,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;SACpH;QAED,OAAO,GAAG,CAAC;IACb,CAAC;IAES,QAAQ,CAAC,QAAgB,EAAE,OAAY;QAC/C,IAAI,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;QAErC,MAAM,MAAM,GAAG,SAAS,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;QAE3D,OAAO,CAAC,OAAY,EAAE,EAAE,CAAC,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;IACrD,CAAC;CACF,CAAA;AApDY,cAAc;IAD1B,UAAU,CAAC,UAAU,CAAC;GACV,cAAc,CAoD1B;SApDY,cAAc","sourcesContent":["import {promisify} from \"util\";\nimport {ViewEngine} from \"../decorators/viewEngine\";\nimport {Engine} from \"./Engine\";\n\n@ViewEngine(\"nunjucks\")\nexport class NunjucksEngine extends Engine {\n  protected configure(options: any) {\n    const engine = options.nunjucksEnv || this.engine;\n    let env = engine;\n\n    // deprecated fallback support for express\n    // <https://github.com/tj/consolidate.js/pull/152>\n    // <https://github.com/tj/consolidate.js/pull/224>\n    if (options.settings && options.settings.views) {\n      env = engine.configure(options.settings.views);\n    } else if (options.nunjucks && options.nunjucks.configure) {\n      // eslint-disable-next-line prefer-spread\n      env = engine.configure.apply(engine, options.nunjucks.configure);\n    }\n\n    //\n    // because `renderString` does not initiate loaders\n    // we must manually create a loader for it based off\n    // either `options.settings.views` or `options.nunjucks` or `options.nunjucks.root`\n    //\n    // <https://github.com/mozilla/nunjucks/issues/730>\n    // <https://github.com/crocodilejs/node-email-templates/issues/182>\n    //\n\n    // so instead we simply check if we passed a custom loader\n    // otherwise we create a simple file based loader\n    if (options.loader) {\n      return new engine.Environment(options.loader);\n    }\n\n    if (options.settings && options.settings.views) {\n      return new engine.Environment(new engine.FileSystemLoader(options.settings.views));\n    }\n\n    if (options.nunjucks && options.nunjucks.loader) {\n      if (typeof options.nunjucks.loader === \"string\") {\n        return new engine.Environment(new engine.FileSystemLoader(options.nunjucks.loader));\n      }\n\n      return new engine.Environment(new engine.FileSystemLoader(options.nunjucks.loader[0], options.nunjucks.loader[1]));\n    }\n\n    return env;\n  }\n\n  protected $compile(template: string, options: any) {\n    let engine = this.configure(options);\n\n    const render = promisify(engine.renderString.bind(engine));\n\n    return (options: any) => render(template, options);\n  }\n}\n"]}
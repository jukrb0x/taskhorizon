import { isObject } from "@tsed/core";
import { mapAliasedProperties } from "../domain/JsonAliasMap.js";
import { SpecTypes } from "../domain/SpecTypes.js";
import { execMapper, hasMapper, registerJsonSchemaMapper } from "../registries/JsonSchemaMapperContainer.js";
import { getRequiredProperties } from "../utils/getRequiredProperties.js";
import { alterOneOf } from "../hooks/alterOneOf.js";
import { mapNullableType } from "../utils/mapNullableType.js";
/**
 * @ignore
 */
const IGNORES = ["name", "$required", "$hooks", "_nestedGenerics", SpecTypes.OPENAPI, SpecTypes.SWAGGER, SpecTypes.JSON];
/**
 * @ignore
 */
const IGNORES_OPENSPEC = ["const"];
/**
 * @ignore
 */
function isEmptyProperties(key, value) {
    return typeof value === "object" && ["items", "properties", "additionalProperties"].includes(key) && Object.keys(value).length === 0;
}
/**
 * @ignore
 */
function shouldMapAlias(key, value, useAlias) {
    return typeof value === "object" && useAlias && ["properties", "additionalProperties"].includes(key);
}
/**
 * @ignore
 */
function shouldSkipKey(key, { specType = SpecTypes.JSON, customKeys = false }) {
    return (IGNORES.includes(key) ||
        (key.startsWith("#") && (customKeys === false || specType !== SpecTypes.JSON)) ||
        (specType !== SpecTypes.JSON && IGNORES_OPENSPEC.includes(key)));
}
function isExample(key, value, options) {
    return key === "examples" && isObject(value) && SpecTypes.OPENAPI === options.specType;
}
export function schemaMapper(schema, options) {
    const { useAlias = true, schemas = {} } = options;
    options = {
        ...options,
        useAlias,
        schemas
    };
    let obj = [...schema.keys()]
        .filter((key) => !shouldSkipKey(key, options))
        .reduce((item, key) => {
        let value = schema.get(key);
        key = key.replace(/^#/, "");
        if (key === "type") {
            return {
                ...item,
                [key]: schema.getJsonType()
            };
        }
        if (isExample(key, value, options)) {
            key = "example";
            value = Object.values(value)[0];
        }
        if (value && typeof value === "object" && hasMapper(key)) {
            value = execMapper(key, value, options, schema);
            if (isEmptyProperties(key, value)) {
                return item;
            }
            if (shouldMapAlias(key, value, useAlias)) {
                value = mapAliasedProperties(value, schema.alias);
            }
        }
        return {
            ...item,
            [key]: value
        };
    }, {});
    if (schema.isClass) {
        obj = execMapper("inheritedClass", obj, { ...options, root: false, schemas, target: schema.getComputedType() });
    }
    obj = execMapper("generics", obj, { ...options, root: false, schemas });
    if (schema.has(options.specType)) {
        obj = {
            ...obj,
            ...schema.get(options.specType).toJSON(options)
        };
    }
    obj = getRequiredProperties(obj, schema, { ...options, useAlias });
    obj = mapNullableType(obj, schema, options);
    obj = alterOneOf(obj, schema, options);
    return obj;
}
registerJsonSchemaMapper("schema", schemaMapper);
//# sourceMappingURL=schemaMapper.js.map
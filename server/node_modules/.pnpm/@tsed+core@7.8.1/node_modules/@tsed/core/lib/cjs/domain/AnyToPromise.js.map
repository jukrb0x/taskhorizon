{"version":3,"file":"AnyToPromise.js","sourceRoot":"","sources":["../../../src/domain/AnyToPromise.ts"],"names":[],"mappings":"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","sourcesContent":["import {isObservable} from \"../utils/objects/isObservable\";\nimport {isPromise} from \"../utils/objects/isPromise\";\nimport {isStream} from \"../utils/objects/isStream\";\n\n/**\n * @ignore\n */\nfunction isResponse(obj: any) {\n  return obj.data && obj.headers && obj.status && obj.statusText;\n}\n\n/**\n * @ignore\n */\nexport enum AnyToPromiseStatus {\n  PENDING = \"PENDING\",\n  CANCELED = \"CANCELED\",\n  RESOLVED = \"RESOLVED\",\n  REJECTED = \"REJECTED\"\n}\n\nexport enum AnyToPromiseResponseTypes {\n  STREAM = \"STREAM\",\n  BUFFER = \"BUFFER\",\n  DATA = \"DATA\"\n}\n\nexport interface AnyPromiseResult<T = any> {\n  state: AnyToPromiseStatus;\n  type: AnyToPromiseResponseTypes;\n  status?: number;\n  headers?: Record<string, any>;\n  data: T;\n}\n\nexport class AnyToPromise<T = any> {\n  public status = AnyToPromiseStatus.PENDING;\n  public args: any[];\n\n  #resolves: any;\n  #rejects: any;\n  #hasNextFunction = false;\n\n  readonly #promise: Promise<AnyPromiseResult<T>>;\n\n  constructor({hasNextFunction = false}: {hasNextFunction?: boolean} = {}) {\n    this.#hasNextFunction = hasNextFunction;\n\n    this.#promise = new Promise((resolve: any, reject: any) => {\n      this.#resolves = resolve;\n      this.#rejects = reject;\n    });\n  }\n\n  isDone(): boolean {\n    return this.status !== AnyToPromiseStatus.PENDING;\n  }\n\n  get next() {\n    this.#hasNextFunction = true;\n\n    return (error?: any) => {\n      if (this.isDone()) {\n        return;\n      }\n\n      return error ? this.reject(error) : this.resolve({type: AnyToPromiseResponseTypes.DATA});\n    };\n  }\n\n  /**\n   *\n   */\n  async call(cb: Function): Promise<AnyPromiseResult<T>> {\n    if (this.isDone()) {\n      return this as any;\n    }\n\n    try {\n      this.handle(cb());\n    } catch (er) {\n      this.reject(er);\n    }\n\n    return this.#promise;\n  }\n\n  reject(er: any) {\n    if (this.isDone()) {\n      return;\n    }\n\n    this.done(AnyToPromiseStatus.REJECTED);\n\n    this.#rejects(er);\n  }\n\n  resolve(response: any = {}) {\n    if (this.isDone()) {\n      return;\n    }\n\n    this.done(AnyToPromiseStatus.RESOLVED);\n\n    this.#resolves({...response, state: AnyToPromiseStatus.RESOLVED});\n  }\n\n  destroy() {}\n\n  cancel() {\n    if (this.isDone()) {\n      return;\n    }\n\n    this.done(AnyToPromiseStatus.CANCELED);\n\n    return this.#resolves({state: AnyToPromiseStatus.CANCELED});\n  }\n\n  done(status: AnyToPromiseStatus) {\n    this.destroy();\n    this.status = status;\n  }\n\n  handle(process: any, additionalProps = {}): any {\n    if (this.isDone()) {\n      return;\n    }\n\n    if (process) {\n      if (this.isCanceledResponse(process)) {\n        // ABANDON\n        return this.cancel();\n      }\n\n      if (isObservable(process)) {\n        process = process.toPromise();\n      }\n\n      if (isResponse(process)) {\n        return this.handle(process.data, {\n          ...additionalProps,\n          status: process.status,\n          headers: process.headers\n        });\n      }\n\n      if (isStream(process)) {\n        return this.resolve({...additionalProps, type: AnyToPromiseResponseTypes.STREAM, data: process});\n      }\n      if (isStream(process) || Buffer.isBuffer(process)) {\n        return this.resolve({...additionalProps, type: AnyToPromiseResponseTypes.BUFFER, data: process});\n      }\n\n      if (isPromise(process)) {\n        return process\n          .then((result: any) => this.handle(result, additionalProps))\n          .catch((error: any) => {\n            if (error.response && isResponse(error.response)) {\n              return this.handle(error.response);\n            }\n            return this.reject(error);\n          });\n      }\n    }\n\n    if (!this.#hasNextFunction) {\n      // no next function and empty response\n      return this.resolve({\n        ...additionalProps,\n        data: process,\n        type: AnyToPromiseResponseTypes.DATA\n      });\n    }\n  }\n\n  protected isCanceledResponse(process: any) {\n    return process === AnyToPromiseStatus.CANCELED;\n  }\n}\n"]}